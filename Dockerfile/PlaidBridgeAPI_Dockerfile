# Stage 1: Python Environment Setup
FROM python:3.12-slim AS python-layer

WORKDIR /app
COPY requirements.txt /app/
RUN pip install --no-cache-dir -r requirements.txt
COPY . /app

# Stage 2: .NET (C#) Environment for Azure Functions
FROM mcr.microsoft.com/dotnet/sdk:6.0 AS dotnet-layer

WORKDIR /functions
COPY ./functions /functions
RUN dotnet restore
RUN dotnet build --configuration Release --output /out


# Stage 3: Final Image for Combined App with Nginx
FROM python:3.12-slim

# Install Nginx
RUN apt-get update && apt-get install -y nginx

# Copy Python app from the python-layer
COPY --from=python-layer /app /app

# Copy C# Azure Functions from the dotnet-layer
COPY --from=dotnet-layer /out /functions

# Copy the updated Nginx configuration
COPY nginx.conf /etc/nginx/nginx.conf

# Set the working directory for the Python app
WORKDIR /app

# Expose ports for Nginx (80) and Azure Functions (7071)
EXPOSE 80 7071

# Define environment variables
ENV NAME plaidbridgeopenbankingapi
ENV FUNCTION_PORT 7071
ENV SQL_CONNECTION_STRING "your_sql_connection_string_here"

# Start Nginx and then your Python app and Azure Functions
CMD service nginx start && python app.py & func start --script-root /functions --port $FUNCTION_PORT
